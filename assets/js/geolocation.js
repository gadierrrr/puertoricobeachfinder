function requestUserLocation(){if(!navigator.geolocation)return void alert("Geolocation is not supported by your browser");const t=document.getElementById("location-btn"),e=document.getElementById("location-icon"),o=document.getElementById("location-text");e&&(e.textContent="‚è≥"),o&&(o.textContent="Getting location..."),t&&(t.disabled=!0),state.geolocationStatus="requesting",navigator.geolocation.getCurrentPosition(e=>{state.userLocation={lat:e.coords.latitude,lng:e.coords.longitude},state.geolocationStatus="granted",localStorage.setItem("userLocation",JSON.stringify(state.userLocation)),onLocationGranted(),t&&(t.disabled=!1),applyFilters(),"map"===state.viewMode&&"function"==typeof addUserMarker&&addUserMarker()},a=>{state.geolocationStatus="denied",e&&(e.textContent="üìç"),o&&(o.textContent="Location denied"),t&&(t.disabled=!1,t.classList.add("border-red-300","text-red-600"));let n="Unable to get your location.";switch(a.code){case a.PERMISSION_DENIED:n="Location access denied. Please enable location in your browser settings.";break;case a.POSITION_UNAVAILABLE:n="Location information unavailable.";break;case a.TIMEOUT:n="Location request timed out. Please try again."}console.warn("Geolocation error:",a);o&&(o.textContent=n.substring(0,30)+"..."),setTimeout(()=>{o&&(o.textContent="Use My Location"),e&&(e.textContent="üìç"),t&&t.classList.remove("border-red-300","text-red-600")},3e3)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})}function calculateDistance(t,e,o,a){const n=toRad(o-t),i=toRad(a-e),s=Math.sin(n/2)*Math.sin(n/2)+Math.cos(toRad(t))*Math.cos(toRad(o))*Math.sin(i/2)*Math.sin(i/2);return 6371e3*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))}function toRad(t){return t*(Math.PI/180)}function formatDistance(t){return t<1e3?Math.round(t)+"m":(t/1e3).toFixed(1)+"km"}function sortByDistance(t){return state.userLocation?t.map(t=>({...t,_distance:calculateDistance(state.userLocation.lat,state.userLocation.lng,parseFloat(t.lat),parseFloat(t.lng))})).sort((t,e)=>t._distance-e._distance):t}function filterByDistance(t,e){if(!state.userLocation)return t;const o=1e3*e;return t.filter(t=>calculateDistance(state.userLocation.lat,state.userLocation.lng,parseFloat(t.lat),parseFloat(t.lng))<=o)}