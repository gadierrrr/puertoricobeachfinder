const MAP_CONFIG={styleUrl:"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",center:window.BeachFinder?.mapCenter||{lat:18.2208,lng:-66.5901},zoom:9,minZoom:7,maxZoom:18};function initializeMap(){if(typeof maplibregl==="undefined"){setTimeout(initializeMap,100);return}if(state.map){return}const e=document.getElementById("map-container");if(e){e.innerHTML='\n        <div class="map-loading">\n            <div class="loading-spinner"></div>\n            <p>Loading map...</p>\n        </div>\n    ';try{state.map=new maplibregl.Map({container:"map-container",style:MAP_CONFIG.styleUrl,center:[MAP_CONFIG.center.lng,MAP_CONFIG.center.lat],zoom:MAP_CONFIG.zoom,minZoom:MAP_CONFIG.minZoom,maxZoom:MAP_CONFIG.maxZoom,attributionControl:!1}),state.map.addControl(new maplibregl.AttributionControl({compact:!0}),"bottom-right"),state.map.addControl(new maplibregl.NavigationControl,"top-right"),state.map.addControl(new maplibregl.ScaleControl({maxWidth:100,unit:"metric"}),"bottom-left");const e=new maplibregl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0,showUserHeading:!0});state.map.addControl(e,"top-right"),e.on("geolocate",e=>{state.userLocation={lat:e.coords.latitude,lng:e.coords.longitude},localStorage.setItem("userLocation",JSON.stringify(state.userLocation)),state.geolocationStatus="granted",onLocationGranted()}),state.map.on("load",()=>{document.querySelector(".map-loading")?.remove(),addBeachMarkers(),addMapLegend(),state.userLocation&&addUserMarker()}),state.map.on("error",e=>{console.error("Map error:",e),showToast("Map failed to load","error")})}catch(t){console.error("Failed to initialize map:",t),e.innerHTML='\n            <div class="flex items-center justify-center h-full bg-gray-100 text-gray-600">\n                <div class="text-center p-8">\n                    <div class="text-4xl mb-4">üó∫Ô∏è</div>\n                    <p class="font-medium">Map failed to load</p>\n                    <p class="text-sm mt-2">Please try refreshing the page</p>\n                    <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">\n                        Refresh Page\n                    </button>\n                </div>\n            </div>\n        '}}else console.error("Map container not found")}function addMapLegend(){const e=document.createElement("div");e.className="map-legend",e.innerHTML=`\n        <div class="legend-title">Legend</div>\n        <div class="legend-item">\n            <span class="legend-icon beach-icon">üèñÔ∏è</span>\n            <span>Beach</span>\n        </div>\n        ${state.userLocation?'\n        <div class="legend-item">\n            <span class="legend-icon user-icon"></span>\n            <span>Your Location</span>\n        </div>\n        ':""}\n        <div class="legend-item">\n            <span class="legend-count">${state.filteredBeaches.length}</span>\n            <span>beaches shown</span>\n        </div>\n    `;const t=document.getElementById("map-container");t?.appendChild(e)}function updateLegendCount(){const e=document.querySelector(".map-legend .legend-count");e&&(e.textContent=state.filteredBeaches.length)}function addBeachMarkers(){if(!state.map)return;state.markers.forEach(e=>e.remove()),state.markers=[];(state.filteredBeaches.length>0?state.filteredBeaches:state.beaches).forEach(e=>{const t=parseFloat(e.lat),a=parseFloat(e.lng);if(!t||!a)return;const n=document.createElement("div");n.className="beach-marker",n.innerHTML="üèñÔ∏è",n.dataset.beachId=e.id;let o="";if(state.userLocation){const e=calculateDistance(state.userLocation.lat,state.userLocation.lng,t,a);o=`<p class="popup-distance">${formatDistance(e)} away</p>`}const s=(e.tags||[]).slice(0,3).map(e=>`<span class="popup-tag">${escapeHtml(window.BeachFinder?.tagLabels?.[e]||e)}</span>`).join(""),r=`\n            <div class="beach-popup">\n                <div class="popup-header">\n                    <h3 class="popup-title">${escapeHtml(e.name)}</h3>\n                    ${e.google_rating?`\n                        <span class="popup-rating">\n                            <span class="text-yellow-500">‚òÖ</span> ${e.google_rating.toFixed(1)}\n                        </span>\n                    `:""}\n                </div>\n                <p class="popup-municipality">${escapeHtml(e.municipality)}</p>\n                ${o}\n                ${s?`<div class="popup-tags">${s}</div>`:""}\n                <div class="popup-actions">\n                    <a href="${getDirectionsUrlFromCoords(t,a,e.name)}"\n                       target="_blank"\n                       rel="noopener noreferrer"\n                       class="popup-btn popup-btn-secondary">\n                       üß≠ Directions\n                    </a>\n                    <button onclick="openBeachDrawer('${e.id}')" class="popup-btn popup-btn-primary">\n                        View Details\n                    </button>\n                </div>\n            </div>\n        `,i=new maplibregl.Popup({offset:25,closeButton:!0,maxWidth:"280px",className:"beach-popup-container"}).setHTML(r),c=new maplibregl.Marker({element:n}).setLngLat([a,t]).setPopup(i).addTo(state.map);n.addEventListener("click",()=>{state.markers.forEach(e=>{e!==c&&e.getPopup()?.remove()}),document.querySelectorAll(".beach-marker").forEach(e=>e.classList.remove("selected")),n.classList.add("selected"),state.selectedBeachId=e.id}),state.markers.push(c)}),updateLegendCount(),state.markers.length>0&&fitMapToMarkers()}function getDirectionsUrlFromCoords(e,t,a){return`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(`${e},${t}`)}&destination_place_id=${encodeURIComponent(a)}`}function updateMapMarkers(){addBeachMarkers()}function addUserMarker(){if(!state.map||!state.userLocation)return;state.userMarker&&state.userMarker.remove();const e=document.createElement("div");e.className="user-marker",e.setAttribute("aria-label","Your location");const t=document.createElement("div");t.className="user-marker-pulse",e.appendChild(t),state.userMarker=new maplibregl.Marker({element:e}).setLngLat([state.userLocation.lng,state.userLocation.lat]).addTo(state.map);const a=document.querySelector(".map-legend");if(a&&!a.querySelector(".user-icon")){const e=document.createElement("div");e.className="legend-item",e.innerHTML='\n            <span class="legend-icon user-icon"></span>\n            <span>Your Location</span>\n        ',a.insertBefore(e,a.querySelector(".legend-item:last-child"))}state.map.flyTo({center:[state.userLocation.lng,state.userLocation.lat],zoom:11,duration:1500})}function fitMapToMarkers(){if(!state.map||0===state.markers.length)return;const e=new maplibregl.LngLatBounds;state.markers.forEach(t=>{e.extend(t.getLngLat())}),state.userLocation&&e.extend([state.userLocation.lng,state.userLocation.lat]),state.map.fitBounds(e,{padding:50,maxZoom:13,duration:1e3})}function centerMapOnBeach(e){if(!state.map)return;const t=state.beaches.find(t=>t.id===e);t&&(state.map.flyTo({center:[parseFloat(t.lng),parseFloat(t.lat)],zoom:14,duration:1500}),state.markers.forEach(t=>{const a=t.getElement();a.dataset.beachId===e?(a.classList.add("selected"),t.togglePopup()):(a.classList.remove("selected"),t.getPopup()?.remove())}),state.selectedBeachId=e)}function escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function showMapView(){setViewMode("map")}function showListView(){setViewMode("list")}