const state={beaches:window.BeachFinder?.beaches||[],filteredBeaches:[],userLocation:null,geolocationStatus:"idle",selectedTags:window.BeachFinder?.selectedTags||[],selectedMunicipality:window.BeachFinder?.selectedMunicipality||"",maxDistance:50,sortBy:window.BeachFinder?.sortBy||"name",viewMode:window.BeachFinder?.viewMode||"list",userFavorites:window.BeachFinder?.userFavorites||[],map:null,markers:[],userMarker:null,selectedBeachId:null,focusTrap:null};function showToast(e,t="info",a=4e3){let s=document.querySelector(".toast-container");s||(s=document.createElement("div"),s.className="toast-container",s.setAttribute("aria-live","polite"),s.setAttribute("aria-atomic","true"),document.body.appendChild(s));const n=document.createElement("div");n.className=`toast toast-${t}`,n.setAttribute("role","alert");const i={success:"‚úì",error:"‚úï",warning:"‚ö†",info:"‚Ñπ"};return n.innerHTML=`\n        <span class="toast-icon">${i[t]||i.info}</span>\n        <span class="toast-message">${escapeHtml(e)}</span>\n        <button class="toast-close" aria-label="Close notification">‚úï</button>\n    `,n.querySelector(".toast-close").addEventListener("click",()=>{removeToast(n)}),s.appendChild(n),requestAnimationFrame(()=>{n.classList.add("show")}),a>0&&setTimeout(()=>{removeToast(n)},a),n}function removeToast(e){e.classList.remove("show"),e.addEventListener("transitionend",()=>{e.remove()},{once:!0})}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function showGridSkeleton(e=6){const t=document.getElementById("beach-grid");t&&(t.innerHTML=Array(e).fill(0).map(()=>'\n        <div class="beach-card skeleton-card">\n            <div class="skeleton skeleton-image"></div>\n            <div class="p-4">\n                <div class="skeleton skeleton-title"></div>\n                <div class="skeleton skeleton-text"></div>\n                <div class="skeleton skeleton-text" style="width: 60%"></div>\n            </div>\n        </div>\n    ').join(""))}function showLoading(e,t="Loading..."){e&&(e.innerHTML=`\n        <div class="loading-state">\n            <div class="loading-spinner" aria-hidden="true"></div>\n            <p class="text-gray-600 mt-3">${escapeHtml(t)}</p>\n        </div>\n    `)}function setButtonLoading(e,t=!0){e&&(t?(e.classList.add("btn-loading"),e.disabled=!0):(e.classList.remove("btn-loading"),e.disabled=!1))}function createFocusTrap(e){const t=["button:not([disabled])","a[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(", "),a=e.querySelectorAll(t),s=a[0],n=a[a.length-1];function i(e){"Tab"===e.key&&(e.shiftKey?document.activeElement===s&&(e.preventDefault(),n?.focus()):document.activeElement===n&&(e.preventDefault(),s?.focus()))}return e.addEventListener("keydown",i),s?.focus(),()=>{e.removeEventListener("keydown",i)}}function setupHtmxListeners(){document.body.addEventListener("htmx:beforeRequest",e=>{const t=e.detail.target,a=e.detail.elt;if("beach-grid"===t?.id){const e=a?.getAttribute("hx-swap");"beforeend"!==e&&showGridSkeleton()}else"drawer-content-inner"===t?.id&&showLoading(t,"Loading beach details...")}),document.body.addEventListener("htmx:afterSwap",e=>{const t=e.detail.target;"drawer-content-inner"===t?.id&&(state.focusTrap=createFocusTrap(t.closest(".drawer-content")))}),document.body.addEventListener("htmx:responseError",e=>{showToast("Something went wrong. Please try again.","error")}),document.body.addEventListener("htmx:afterRequest",e=>{if(e.detail.pathInfo?.requestPath?.includes("toggle-favorite")){const t=e.detail.xhr?.response;t?.includes("‚ù§Ô∏è")?showToast("Added to favorites!","success",2e3):t?.includes("ü§ç")&&showToast("Removed from favorites","info",2e3)}})}function initMunicipalitySelect(){const e=document.getElementById("municipality-filter");e&&"undefined"!=typeof TomSelect&&new TomSelect(e,{create:!1,sortField:{field:"text",direction:"asc"},placeholder:"Search municipalities...",allowEmptyOption:!0,onChange:()=>applyFiltersWithHtmx()})}function updateResultsCount(){const e=document.getElementById("results-count");if(e){const t=state.filteredBeaches.length,a=state.userLocation?" near you":"";e.textContent=`${t} beach${1!==t?"es":""} found${a}`}}function renderFilterChips(){const e=document.getElementById("applied-filters");if(!e)return;const t=[];state.selectedMunicipality&&t.push(`\n            <span class="filter-chip">\n                üìç ${escapeHtml(state.selectedMunicipality)}\n                <button class="remove-btn" onclick="removeFilter('municipality')" aria-label="Remove municipality filter">‚úï</button>\n            </span>\n        `),state.selectedTags.forEach(e=>{const a=window.BeachFinder?.tagLabels?.[e]||e;t.push(`\n            <span class="filter-chip">\n                üè∑Ô∏è ${escapeHtml(a)}\n                <button class="remove-btn" onclick="removeFilter('tag', '${escapeHtml(e)}')" aria-label="Remove ${escapeHtml(a)} filter">‚úï</button>\n            </span>\n        `)}),state.userLocation&&state.maxDistance<50&&t.push(`\n            <span class="filter-chip">\n                üìè Within ${state.maxDistance}km\n                <button class="remove-btn" onclick="removeFilter('distance')" aria-label="Remove distance filter">‚úï</button>\n            </span>\n        `),t.length>0&&t.push('\n            <button class="filter-chip clear-all" onclick="clearFilters()">\n                Clear all\n            </button>\n        '),e.innerHTML=t.join(""),e.style.display=t.length>0?"flex":"none"}function removeFilter(e,t=null){switch(e){case"municipality":state.selectedMunicipality="";const e=document.getElementById("municipality-filter");e&&(e.tomselect?e.tomselect.clear():e.value="");break;case"tag":if(t)return void toggleTag(t);break;case"distance":state.maxDistance=50;const a=document.getElementById("distance-filter");a&&(a.value=50);const s=document.getElementById("distance-value");s&&(s.textContent="50km")}applyFiltersWithHtmx()}function setViewMode(e){state.viewMode=e;const t=document.getElementById("list-view"),a=document.getElementById("map-view"),s=document.getElementById("view-list-btn"),n=document.getElementById("view-map-btn");"map"===e?(t?.classList.add("hidden"),a?.classList.remove("hidden"),s?.classList.remove("bg-blue-600","text-white"),s?.classList.add("bg-white","text-gray-700","hover:bg-gray-50"),n?.classList.add("bg-blue-600","text-white"),n?.classList.remove("bg-white","text-gray-700","hover:bg-gray-50"),state.map||"function"!=typeof initializeMap?"function"==typeof updateMapMarkers&&updateMapMarkers():initializeMap()):(a?.classList.add("hidden"),t?.classList.remove("hidden"),n?.classList.remove("bg-blue-600","text-white"),n?.classList.add("bg-white","text-gray-700","hover:bg-gray-50"),s?.classList.add("bg-blue-600","text-white"),s?.classList.remove("bg-white","text-gray-700","hover:bg-gray-50")),updateURL()}function showMapView(){setViewMode("map")}function toggleTag(e){const t=state.selectedTags.indexOf(e);-1===t?state.selectedTags.push(e):state.selectedTags.splice(t,1);const a=document.querySelector(`[data-tag="${e}"]`);a&&(state.selectedTags.includes(e)?(a.classList.add("bg-blue-600","text-white"),a.classList.remove("bg-gray-100","text-gray-700","hover:bg-gray-200"),a.setAttribute("aria-pressed","true")):(a.classList.remove("bg-blue-600","text-white"),a.classList.add("bg-gray-100","text-gray-700","hover:bg-gray-200"),a.setAttribute("aria-pressed","false")));const s=document.getElementById("clear-filters-btn");s&&(state.selectedTags.length>0||state.selectedMunicipality?s.classList.remove("hidden"):s.classList.add("hidden")),applyFiltersWithHtmx()}function clearFilters(){state.selectedTags=[],state.selectedMunicipality="",state.maxDistance=50,document.querySelectorAll(".tag-btn").forEach(e=>{e.classList.remove("bg-blue-600","text-white"),e.classList.add("bg-gray-100","text-gray-700","hover:bg-gray-200"),e.setAttribute("aria-pressed","false")});const e=document.getElementById("municipality-filter");e&&(e.tomselect?e.tomselect.clear():e.value="");const t=document.getElementById("distance-filter");t&&(t.value=50);const a=document.getElementById("clear-filters-btn");a&&a.classList.add("hidden"),showToast("All filters cleared","info",2e3),applyFiltersWithHtmx()}function applyFiltersWithHtmx(){const e=document.getElementById("municipality-filter"),t=document.getElementById("sort-filter"),a=document.getElementById("distance-filter");state.selectedMunicipality=e?.value||"",state.sortBy=t?.value||"name",state.maxDistance=parseInt(a?.value||50);const s=document.getElementById("distance-value");s&&(s.textContent=state.maxDistance+"km"),filterBeachesClientSide(),updateResultsCount(),renderFilterChips(),updateURL(),"map"===state.viewMode&&"function"==typeof updateMapMarkers&&updateMapMarkers();const n=buildQueryParams();document.getElementById("beach-grid")&&"undefined"!=typeof htmx&&htmx.ajax("GET",`/api/beaches.php?${n.toString()}`,{target:"#beach-grid",swap:"innerHTML"})}function applyFilters(){applyFiltersWithHtmx()}function filterBeachesClientSide(){let e=[...state.beaches];if(state.selectedTags.length>0&&(e=e.filter(e=>{const t=e.tags||[];return state.selectedTags.some(e=>t.includes(e))})),state.selectedMunicipality&&(e=e.filter(e=>e.municipality===state.selectedMunicipality)),state.userLocation){const t=1e3*state.maxDistance;e=e.filter(e=>{const a=calculateDistance(state.userLocation.lat,state.userLocation.lng,parseFloat(e.lat),parseFloat(e.lng));return e._distance=a,a<=t})}switch(state.sortBy){case"distance":state.userLocation&&e.sort((e,t)=>(e._distance||0)-(t._distance||0));break;case"rating":e.sort((e,t)=>(t.google_rating||0)-(e.google_rating||0));break;default:e.sort((e,t)=>e.name.localeCompare(t.name))}state.filteredBeaches=e}function buildQueryParams(){const e=new URLSearchParams;return state.selectedTags.length>0&&state.selectedTags.forEach(t=>e.append("tags[]",t)),state.selectedMunicipality&&e.set("municipality",state.selectedMunicipality),"name"!==state.sortBy&&e.set("sort",state.sortBy),"list"!==state.viewMode&&e.set("view",state.viewMode),e}function updateURL(){const e=buildQueryParams(),t=e.toString()?"?"+e.toString():window.location.pathname;history.replaceState(null,"",t)}function reloadBeachGrid(){const e=buildQueryParams();window.location.search=e.toString()}function openBeachDrawer(e){state.selectedBeachId=e;const t=document.getElementById("beach-drawer"),a=document.getElementById("drawer-content-inner");t&&a&&(state.previousFocus=document.activeElement,a.innerHTML='\n        <div class="drawer-loading">\n            <div class="drawer-handle" aria-hidden="true"></div>\n            <div class="skeleton skeleton-image" style="height: 200px; margin-bottom: 1rem;"></div>\n            <div class="p-6">\n                <div class="skeleton skeleton-title" style="width: 70%; margin-bottom: 1rem;"></div>\n                <div class="skeleton skeleton-text" style="margin-bottom: 0.5rem;"></div>\n                <div class="skeleton skeleton-text" style="width: 80%; margin-bottom: 0.5rem;"></div>\n                <div class="skeleton skeleton-text" style="width: 60%;"></div>\n            </div>\n        </div>\n    ',t.classList.add("open"),document.body.style.overflow="hidden",htmx.ajax("GET",`/api/beach-detail.php?id=${e}`,{target:"#drawer-content-inner",swap:"innerHTML"}))}function closeBeachDrawer(e){if(e&&e.target!==document.getElementById("beach-drawer"))return;const t=document.getElementById("beach-drawer");t&&(t.classList.remove("open"),document.body.style.overflow="",state.selectedBeachId=null,state.focusTrap&&(state.focusTrap(),state.focusTrap=null),state.previousFocus&&(state.previousFocus.focus(),state.previousFocus=null))}function onLocationGranted(){const e=document.getElementById("location-btn"),t=document.getElementById("location-icon"),a=document.getElementById("location-text"),s=document.getElementById("distance-filter-container"),n=document.getElementById("sort-distance-option");e&&(e.classList.add("bg-green-50","border-green-300","text-green-700"),e.classList.remove("border-gray-300")),t&&(t.textContent="‚úì"),a&&(a.textContent="Location enabled"),s&&s.classList.remove("hidden"),n&&(n.disabled=!1),updateDistanceBadges(),showToast("Location enabled! Distances are now shown.","success",3e3)}function updateDistanceBadges(){state.userLocation&&document.querySelectorAll(".beach-card").forEach(e=>{const t=parseFloat(e.dataset.lat),a=parseFloat(e.dataset.lng);if(t&&a){const s=calculateDistance(state.userLocation.lat,state.userLocation.lng,t,a);let n=e.querySelector(".distance-badge");n||(n=document.createElement("div"),n.className="distance-badge absolute top-3 right-3 bg-blue-600 text-white text-xs font-semibold px-2 py-1 rounded-full shadow",e.querySelector(".relative")?.appendChild(n)),n.textContent=formatDistance(s)}})}document.addEventListener("DOMContentLoaded",()=>{state.filteredBeaches=[...state.beaches],updateResultsCount(),renderFilterChips();const e=localStorage.getItem("userLocation");if(e)try{const t=JSON.parse(e);t.lat&&t.lng&&(state.userLocation=t,state.geolocationStatus="granted",onLocationGranted())}catch(e){localStorage.removeItem("userLocation")}"map"===state.viewMode&&showMapView(),document.addEventListener("keydown",e=>{"Escape"===e.key&&(closeBeachDrawer(),closeShareModal())}),setupHtmxListeners(),initMunicipalitySelect(),console.log("Beach Finder initialized with",state.beaches.length,"beaches"),initTheme()});

// Theme Toggle Functions (Nomads-style dark mode)
function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.documentElement.setAttribute('data-theme', 'dark');
    } else {
        document.documentElement.setAttribute('data-theme', 'light');
    }

    // Re-initialize Lucide icons for theme
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);

    // Re-initialize icons for theme change
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Show feedback toast
    showToast(newTheme === 'dark' ? 'Dark mode enabled' : 'Light mode enabled', 'info', 2000);
}